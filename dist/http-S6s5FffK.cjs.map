{"version":3,"file":"http-S6s5FffK.cjs","names":["url: string","options: FullRequestOptions","requestFlowPersistentData: Record<string, unknown>","statusCode: number","headers: Map<string, string | string[]>","body: Buffer","key: string","response: Undici.Dispatcher.ResponseData","headers: IncomingHttpHeaders","request: HttpRequest","response: HttpResponse","event: PreRequestEvent | PostRequestEvent","listener: ((event: any) => Promise<void> | void)[]","event: HttpClientEventType","callback: ((event: PreRequestEvent) => void | Promise<void>) | ((event: PostRequestEvent) => void | Promise<void>)","userAgent: string","url: string","options?: GetRequestOptions","options?: PostRequestOptions","request: HttpRequest","Undici","_request: HttpRequest","headers?: FullRequestOptions['headers']","appName: string","appVersion: string","includeSystemInfo: boolean","infoOrAppUrl?: string","Os"],"sources":["../src/http/HttpRequest.ts","../src/http/HttpResponse.ts","../src/http/client/HttpClientEvents.ts","../src/http/client/HttpClient.ts","../src/http/client/UndiciHttpClient.ts","../src/http/util/UserAgentGenerator.ts","../src/http/index.ts"],"sourcesContent":["import type { FullRequestOptions } from './client/HttpClient.ts';\n\nexport default class HttpRequest {\n  constructor(\n    public url: string,\n    public options: FullRequestOptions,\n    public readonly requestFlowPersistentData: Record<string, unknown> = {},\n  ) {\n  }\n}\n","import type * as Undici from 'undici';\nimport type { IncomingHttpHeaders } from 'undici/types/header.js';\n\nexport default class HttpResponse {\n  /**\n   * They keys of the `headers`-Map are expected to always be in lowercase.\n   */\n  constructor(\n    public readonly statusCode: number,\n    public readonly headers: Map<string, string | string[]>,\n    public readonly body: Buffer,\n  ) {\n  }\n\n  get ok(): boolean {\n    return this.statusCode >= 200 && this.statusCode < 300;\n  }\n\n  getHeader(key: string): string | null;\n  getHeader(key: 'Set-Cookie'): string[] | null;\n  getHeader(key: string): string | string[] | null {\n    return this.headers.get(key.toLowerCase()) ?? null;\n  }\n\n  parseBodyAsText(): string {\n    return this.body.toString('utf8');\n  }\n\n  parseBodyAsJson<T>(): T {\n    return JSON.parse(this.parseBodyAsText());\n  }\n\n  static async fromUndiciResponse(response: Undici.Dispatcher.ResponseData): Promise<HttpResponse> {\n    return new HttpResponse(\n      response.statusCode,\n      this.parseHeaders(response.headers),\n      Buffer.from(await response.body.arrayBuffer()),\n    );\n  }\n\n  private static parseHeaders(headers: IncomingHttpHeaders): Map<string, string | string[]> {\n    const parsedHeaders = new Map<string, string | string[]>();\n    for (const [key, value] of Object.entries(headers)) {\n      if (value != null) {\n        parsedHeaders.set(key.toLowerCase(), value);\n      }\n    }\n    return parsedHeaders;\n  }\n}\n","import type HttpRequest from '../HttpRequest.ts';\nimport type HttpResponse from '../HttpResponse.ts';\n\nexport type HttpClientEventType = 'preRequest' | 'postRequest';\n\nexport class PreRequestEvent {\n  constructor(\n    public readonly request: HttpRequest,\n  ) {\n  }\n}\n\nexport class PostRequestEvent {\n  constructor(\n    public readonly request: HttpRequest,\n    public readonly response: HttpResponse,\n  ) {\n  }\n}\n","import type HttpRequest from '../HttpRequest.ts';\nimport HttpResponse from '../HttpResponse.ts';\nimport { HttpClientEventType, PostRequestEvent, PreRequestEvent } from './HttpClientEvents.ts';\n\nexport type BaseRequestOptions = {\n  headers?: { [key: string]: string };\n}\n\nexport interface GetRequestOptions extends BaseRequestOptions {\n  query?: { [key: string]: string | number | boolean };\n}\n\nexport interface PostRequestOptions extends BaseRequestOptions {\n  body?: Buffer | string;\n}\n\nexport interface FullRequestOptions extends BaseRequestOptions, GetRequestOptions, PostRequestOptions {\n  method: 'GET' | 'POST';\n}\n\nexport default abstract class HttpClient {\n  protected readonly eventListener: {\n    pre: ((event: PreRequestEvent) => Promise<void> | void)[],\n    post: ((event: PostRequestEvent) => Promise<void> | void)[],\n  } = { pre: [], post: [] };\n\n  public abstract get(url: string, options?: GetRequestOptions): Promise<HttpResponse>;\n\n  public abstract post(url: string, options?: PostRequestOptions): Promise<HttpResponse>;\n\n  protected abstract request(request: HttpRequest): Promise<HttpResponse>;\n\n  protected async emitEvent(event: PreRequestEvent | PostRequestEvent): Promise<void> {\n    let listener: ((event: any) => Promise<void> | void)[];\n    if (event instanceof PreRequestEvent) {\n      listener = this.eventListener.pre;\n    } else {\n      listener = this.eventListener.post;\n    }\n\n    for (const listenerFunction of listener) {\n      await listenerFunction(event);\n    }\n  }\n\n  public addEventListener(event: 'preRequest', callback: (event: PreRequestEvent) => void | Promise<void>): void;\n  public addEventListener(event: 'postRequest', callback: (event: PostRequestEvent) => void | Promise<void>): void;\n  public addEventListener(event: HttpClientEventType, callback: ((event: PreRequestEvent) => void | Promise<void>) | ((event: PostRequestEvent) => void | Promise<void>)): void {\n    if (event === 'preRequest') {\n      this.eventListener.pre.push(callback as any);\n      return;\n    } else if (event === 'postRequest') {\n      this.eventListener.post.push(callback as any);\n      return;\n    }\n\n    throw new Error(`Unknown event type: ${event}`);\n  }\n}\n","import * as Undici from 'undici';\nimport HttpRequest from '../HttpRequest.ts';\nimport HttpResponse from '../HttpResponse.ts';\nimport HttpClient, { type FullRequestOptions, type GetRequestOptions, type PostRequestOptions } from './HttpClient.ts';\nimport { PostRequestEvent, PreRequestEvent } from './HttpClientEvents.ts';\n\nexport default class UndiciHttpClient extends HttpClient {\n  private agent?: Undici.Dispatcher;\n\n  constructor(\n    protected userAgent: string,\n  ) {\n    super();\n  }\n\n  get(url: string, options?: GetRequestOptions): Promise<HttpResponse> {\n    return this.request(new HttpRequest(url, {\n      ...options,\n      method: 'GET',\n    }));\n  }\n\n  post(url: string, options?: PostRequestOptions): Promise<HttpResponse> {\n    return this.request(new HttpRequest(url, {\n      ...options,\n      method: 'POST',\n    }));\n  }\n\n  protected async request(request: HttpRequest): Promise<HttpResponse> {\n    await this.emitEvent(new PreRequestEvent(request));\n\n    const dispatcher = this.selectDispatcher(request);\n    const response = await Undici.request(request.url, {\n      dispatcher,\n\n      method: request.options.method,\n      query: request.options.query,\n      body: request.options.body,\n      headers: this.mergeWithDefaultHeaders(request.options.headers),\n    });\n\n    const httpResponse = await HttpResponse.fromUndiciResponse(response);\n    await this.emitEvent(new PostRequestEvent(request, httpResponse));\n    return httpResponse;\n  }\n\n  protected selectDispatcher(_request: HttpRequest): Undici.Dispatcher {\n    if (this.agent === undefined) {\n      this.agent = new Undici.Agent(this.getDefaultAgentOptions());\n    }\n    return this.agent;\n  }\n\n  protected getDefaultAgentOptions(): Undici.Agent.Options {\n    return {\n      maxResponseSize: 20 * 1024 * 1024 /* 20 MiB */,\n      bodyTimeout: 12_000,\n      headersTimeout: 12_000,\n    };\n  }\n\n  private mergeWithDefaultHeaders(headers?: FullRequestOptions['headers']): Map<string, string | string[]> {\n    const mergedHeaders = new Map<string, string | string[]>();\n    mergedHeaders.set('user-agent', this.userAgent);\n    mergedHeaders.set('accept', 'application/json');\n\n    if (headers != null) {\n      for (const [key, value] of Object.entries(headers)) {\n        mergedHeaders.set(key.toLowerCase(), value);\n      }\n    }\n    return mergedHeaders;\n  }\n}\n","import Os from 'node:os';\n\nexport default class UserAgentGenerator {\n  static generate(appName: string, appVersion: string, includeSystemInfo: boolean = true, infoOrAppUrl?: string): string {\n    let userAgent = `${appName}/${appVersion}`;\n\n    if (includeSystemInfo) {\n      userAgent += ` (${Os.type()}; ${process.arch}; ${process.platform})`;\n    }\n\n    if (infoOrAppUrl != null) {\n      userAgent += ` (+${infoOrAppUrl})`;\n    }\n\n    return userAgent;\n  }\n}\n","//noinspection JSUnusedGlobalSymbols\n\nexport { default as HttpRequest } from './HttpRequest.ts';\nexport { default as HttpResponse } from './HttpResponse.ts';\n\nexport * as HttpClientEvents from './client/HttpClientEvents.ts';\nexport {\n  default as HttpClient,\n  type GetRequestOptions,\n  type PostRequestOptions,\n  type FullRequestOptions,\n} from './client/HttpClient.ts';\nexport { default as UndiciHttpClient } from './client/UndiciHttpClient.ts';\n\nexport { default as UserAgentGenerator } from './util/UserAgentGenerator.ts';\n"],"mappings":"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"}